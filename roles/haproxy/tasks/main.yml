---
# This role contains the steps to set up the haproxy configuration and container

- name:
  file:
    path: /etc/haproxy
    state: directory
    mode: 0755

- name: Configure the haproxy cnf file with hosts
  template: src=haproxy.cfg.j2 dest=/etc/haproxy/haproxy.cfg

- name: Add selfsigned cert
  copy: src=selfsigned.pem dest=/etc/haproxy/selfsigned.pem

- name: Add Dockerfile
  copy: src=Dockerfile dest=/etc/haproxy/Dockerfile

- name: Build the container
  shell: cd /etc/haproxy && docker build -t my-haproxy .

- name: Start the container
  shell: "docker run \
         -d \
         -p 7500:7500/tcp \
         -p 3607-3610:3607-3610/tcp \
         --network db-net \
         --ip {{ haproxy_ip }} \
         --name haproxy-for-databases \
         -v /etc/haproxy:/usr/local/etc/haproxy:ro \
         my-haproxy:latest"